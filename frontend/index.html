<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Director's Cut</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
/* â”€â”€â”€ RESET & ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #0a0a0f;
  --bg2:        #0f0f18;
  --bg3:        #13131f;
  --border:     #1e1e2e;
  --border2:    #2a2a3d;
  --gold:       #c9a84c;
  --gold-dim:   #6e5928;
  --amber:      #e8934a;
  --red:        #c0392b;
  --green:      #2ecc71;
  --white:      #f0ede6;
  --white-dim:  #8a8878;
  --white-faint:#3a3930;
  --mono:       'IBM Plex Mono', monospace;
  --serif:      'Playfair Display', Georgia, serif;
}

html, body {
  width: 100%; height: 100%;
  background: var(--bg);
  color: var(--white);
  font-family: var(--mono);
  overflow: hidden;
}

/* â”€â”€â”€ FILM GRAIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 9999;
  pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
  background-size: 200px 200px;
  opacity: 0.45;
  animation: grain 0.18s steps(1) infinite;
}

/* â”€â”€â”€ SCAN LINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 9998;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.12) 2px,
    rgba(0,0,0,0.12) 4px
  );
}

@keyframes grain {
  0%,100% { transform: translate(0,0); }
  10%     { transform: translate(-1%,-1%); }
  20%     { transform: translate(1%,0); }
  30%     { transform: translate(0,1%); }
  40%     { transform: translate(-1%,1%); }
  50%     { transform: translate(1%,-1%); }
  60%     { transform: translate(-1%,0); }
  70%     { transform: translate(1%,1%); }
  80%     { transform: translate(0,-1%); }
  90%     { transform: translate(-1%,1%); }
}

/* â”€â”€â”€ APP GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app {
  display: grid;
  grid-template-rows: 52px 1fr 72px 48px;
  height: 100vh;
  max-height: 100vh;
}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  position: relative;
}

#header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.sprocket {
  display: flex;
  gap: 4px;
  align-items: center;
}

.sprocket-hole {
  width: 8px; height: 8px;
  border-radius: 50%;
  border: 1px solid var(--border2);
  background: var(--bg);
}

#title {
  font-family: var(--serif);
  font-size: 20px;
  font-weight: 900;
  letter-spacing: 0.06em;
  color: var(--white);
  text-transform: uppercase;
  font-style: italic;
}

#title span { color: var(--gold); }

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 10px;
  color: var(--white-dim);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

#genre-label { color: var(--gold); }

#rec-indicator {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 9px;
  opacity: 0;
  transition: opacity 0.5s;
}

#rec-indicator.active { opacity: 1; }

#rec-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--red);
  animation: blink 1.2s ease-in-out infinite;
}

@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* â”€â”€â”€ CONTENT GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content {
  display: grid;
  grid-template-columns: 1fr 280px;
  overflow: hidden;
}

/* â”€â”€â”€ SCENE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scene-panel {
  position: relative;
  background: #000;
  overflow: hidden;
  border-right: 1px solid var(--border);
}

#scene-img {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
  transition: opacity 0.8s ease;
  opacity: 0;
}

#scene-img.visible { opacity: 1; }
#scene-img.fading  { opacity: 0; }

/* Letterbox bars */
#scene-panel::before,
#scene-panel::after {
  content: '';
  position: absolute;
  left: 0; right: 0;
  height: 8%;
  background: #000;
  z-index: 10;
  pointer-events: none;
}
#scene-panel::before { top: 0; }
#scene-panel::after  { bottom: 0; }

/* Vignette */
#vignette {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.7) 100%);
  z-index: 11; pointer-events: none;
}

/* Idle overlay */
#idle-overlay {
  position: absolute; inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 20;
  background: #000;
  transition: opacity 0.6s;
}

#idle-overlay.hidden { opacity: 0; pointer-events: none; }

.idle-aperture {
  width: 100px; height: 100px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  position: relative;
  margin-bottom: 20px;
  animation: rotateSlow 8s linear infinite;
}

.idle-aperture::before {
  content: '';
  position: absolute; inset: 8px;
  border-radius: 50%;
  border: 1px solid var(--gold-dim);
}

.idle-aperture::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 12px; height: 12px;
  border-radius: 50%;
  background: var(--gold-dim);
  transform: translate(-50%,-50%);
}

@keyframes rotateSlow { to { transform: rotate(360deg); } }

.idle-text {
  font-family: var(--serif);
  font-size: 28px;
  font-style: italic;
  color: var(--white-dim);
  letter-spacing: 0.04em;
}

.idle-sub {
  margin-top: 6px;
  font-size: 10px;
  letter-spacing: 0.18em;
  color: var(--white-faint);
  text-transform: uppercase;
}

/* Deciding overlay */
#deciding-overlay {
  position: absolute; inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(10,10,15,0.88);
  z-index: 30;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s;
}

#deciding-overlay.active { opacity: 1; pointer-events: all; }

.deciding-ring {
  width: 70px; height: 70px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  border-top-color: var(--gold);
  animation: spin 0.9s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.deciding-label {
  font-family: var(--serif);
  font-style: italic;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 0.08em;
}

.deciding-sub {
  margin-top: 4px;
  font-size: 9px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--white-dim);
}

/* Calibration overlay */
#calibrate-overlay {
  position: absolute; inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(10,10,15,0.92);
  z-index: 25;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s;
}

#calibrate-overlay.active { opacity: 1; pointer-events: all; }

#calibrate-count {
  font-family: var(--serif);
  font-size: 96px;
  font-weight: 900;
  color: var(--gold);
  line-height: 1;
  animation: countPulse 1s ease-out;
}

@keyframes countPulse {
  0%   { transform: scale(1.4); opacity: 0; }
  30%  { opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

#calibrate-label {
  font-size: 10px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--white-dim);
  margin-top: 8px;
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  background: var(--bg2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-section {
  padding: 14px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.section-label {
  font-size: 8px;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--white-faint);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* Webcam */
#webcam-wrap {
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border: 1px solid var(--border2);
  overflow: hidden;
  border-radius: 2px;
}

#webcam {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
  transform: scaleX(-1);
}

#crosshair {
  position: absolute; inset: 0;
  pointer-events: none;
}

.ch-corner {
  position: absolute;
  width: 14px; height: 14px;
  border-color: var(--gold);
  border-style: solid;
  opacity: 0.6;
}

.ch-tl { top: 10px; left: 10px; border-width: 1px 0 0 1px; }
.ch-tr { top: 10px; right: 10px; border-width: 1px 1px 0 0; }
.ch-bl { bottom: 10px; left: 10px; border-width: 0 0 1px 1px; }
.ch-br { bottom: 10px; right: 10px; border-width: 0 1px 1px 0; }

.crosshair-center {
  position: absolute;
  top: 50%; left: 50%;
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 1px solid rgba(201,168,76,0.4);
  transform: translate(-50%,-50%);
}

#cam-status {
  margin-top: 6px;
  font-size: 9px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--white-faint);
  text-align: center;
}

#cam-status.ok    { color: var(--green); }
#cam-status.error { color: var(--red);   }

/* â”€â”€â”€ EMOTION SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#emotion-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 14px;
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  min-height: 0;
}

#emotion-display {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

#emotion-emoji {
  font-size: 36px;
  line-height: 1;
  filter: drop-shadow(0 0 8px rgba(201,168,76,0.3));
  transition: transform 0.5s cubic-bezier(0.34,1.56,0.64,1);
  display: inline-block;
}

#emotion-info { flex: 1; }

#emotion-label {
  font-family: var(--serif);
  font-size: 16px;
  font-style: italic;
  color: var(--white);
  text-transform: capitalize;
  transition: color 0.4s;
}

#emotion-meta {
  font-size: 9px;
  letter-spacing: 0.1em;
  color: var(--white-faint);
  text-transform: uppercase;
  margin-top: 2px;
}

#intensity-bar-wrap { margin-bottom: 10px; }

#intensity-label {
  font-size: 8px;
  letter-spacing: 0.15em;
  color: var(--white-faint);
  text-transform: uppercase;
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}

#intensity-track {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

#intensity-fill {
  height: 100%;
  width: 50%;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold), var(--amber));
  border-radius: 2px;
  transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
}

#attention-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.metric-pill {
  flex: 1;
  padding: 5px 8px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 2px;
  text-align: center;
}

.metric-pill .val {
  font-size: 12px;
  font-weight: 500;
  color: var(--gold);
  display: block;
}

.metric-pill .key {
  font-size: 7px;
  letter-spacing: 0.12em;
  color: var(--white-faint);
  text-transform: uppercase;
}

#emotion-history {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.hist-dot {
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--bg3);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  transition: all 0.3s;
}

.hist-dot.active {
  border-color: var(--gold-dim);
  background: var(--bg);
}

/* â”€â”€â”€ SCENE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scene-list-section {
  flex: 1;
  overflow-y: auto;
  padding: 10px 14px;
  min-height: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}

.scene-entry {
  font-size: 9px;
  letter-spacing: 0.08em;
  color: var(--white-faint);
  padding: 4px 0;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 6px;
  align-items: center;
  text-transform: uppercase;
}

.scene-entry .s-num {
  color: var(--gold-dim);
  font-size: 8px;
  flex-shrink: 0;
}

.scene-entry.current { color: var(--white); }
.scene-entry.current .s-num { color: var(--gold); }

/* â”€â”€â”€ INFO BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#info-bar {
  padding: 10px 20px;
  background: rgba(10,10,15,0.92);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(4px);
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 20px;
}

#narration {
  font-family: var(--serif);
  font-size: 13px;
  font-style: italic;
  color: var(--white);
  line-height: 1.4;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: opacity 0.6s;
}

#scene-meta {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-shrink: 0;
  font-size: 9px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--white-faint);
}

#chapter-name { color: var(--gold-dim); }

#scene-counter {
  background: var(--border);
  padding: 2px 6px;
  border-radius: 2px;
  font-size: 8px;
}

/* â”€â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  background: var(--bg2);
  border-top: 1px solid var(--border);
}

.controls-left {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  padding: 8px 18px;
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--white-dim);
  cursor: pointer;
  border-radius: 1px;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute; inset: 0;
  background: var(--gold);
  opacity: 0;
  transition: opacity 0.2s;
}

.btn:hover::before { opacity: 0.08; }
.btn:hover { border-color: var(--gold-dim); color: var(--white); }
.btn:active { transform: scale(0.98); }

.btn.primary {
  border-color: var(--gold-dim);
  color: var(--gold);
}

.btn.primary:hover {
  border-color: var(--gold);
  background: rgba(201,168,76,0.08);
}

.btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.btn:disabled:hover::before { opacity: 0; }

#status-text {
  font-size: 9px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--white-faint);
  text-align: right;
  transition: color 0.4s;
}

#status-text.active { color: var(--gold); }
#status-text.error  { color: var(--red);  }

#ws-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--white-faint);
  display: inline-block;
  margin-right: 5px;
  vertical-align: middle;
  transition: background 0.4s;
}

#ws-dot.connected { background: var(--green); }
#ws-dot.error     { background: var(--red);   }

/* â”€â”€â”€ END SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#end-screen {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(5,5,10,0.97);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.8s;
}

#end-screen.active { opacity: 1; pointer-events: all; }

.end-inner {
  width: 560px;
  max-width: 90vw;
  text-align: center;
}

.end-rule {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
  margin: 20px 0;
}

.end-eyebrow {
  font-size: 9px;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--gold-dim);
  margin-bottom: 10px;
}

.end-title {
  font-family: var(--serif);
  font-size: 42px;
  font-weight: 900;
  font-style: italic;
  color: var(--white);
  line-height: 1.1;
  margin-bottom: 6px;
}

.end-ending-name {
  font-family: var(--serif);
  font-size: 20px;
  font-style: italic;
  color: var(--gold);
  margin-bottom: 4px;
}

.end-emotion-summary {
  font-size: 10px;
  letter-spacing: 0.12em;
  color: var(--white-dim);
  text-transform: uppercase;
  margin-bottom: 20px;
}

.end-scenes {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 12px 16px;
  margin-bottom: 20px;
  text-align: left;
  max-height: 160px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}

.end-scenes-label {
  font-size: 8px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--white-faint);
  margin-bottom: 8px;
}

.end-scene-item {
  font-size: 10px;
  letter-spacing: 0.08em;
  color: var(--white-dim);
  padding: 3px 0;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 8px;
  text-transform: uppercase;
}

.end-scene-item .idx { color: var(--gold-dim); }

.end-cta {
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* â”€â”€â”€ HIDDEN CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#capture-canvas { display: none; }
</style>
</head>
<body>

<div id="app">

  <!-- HEADER -->
  <header id="header">
    <div class="header-left">
      <div class="sprocket">
        <div class="sprocket-hole"></div>
        <div class="sprocket-hole"></div>
        <div class="sprocket-hole"></div>
      </div>
      <h1 id="title"><span>Director's</span> Cut</h1>
      <div class="sprocket">
        <div class="sprocket-hole"></div>
        <div class="sprocket-hole"></div>
        <div class="sprocket-hole"></div>
      </div>
    </div>
    <div class="header-right">
      <span>Genre:</span>
      <span id="genre-label">Mystery</span>
      <div style="width:1px;height:14px;background:var(--border2)"></div>
      <div id="rec-indicator">
        <div id="rec-dot"></div>
        <span>REC</span>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main id="content">

    <!-- Scene panel -->
    <section id="scene-panel">
      <div id="idle-overlay">
        <div class="idle-aperture"></div>
        <p class="idle-text">The Inheritance</p>
        <p class="idle-sub">An Adaptive Mystery Film</p>
      </div>

      <div id="calibrate-overlay">
        <div id="calibrate-count">3</div>
        <div id="calibrate-label">Get in frameâ€¦</div>
      </div>

      <div id="deciding-overlay">
        <div class="deciding-ring"></div>
        <div class="deciding-label">The Director Decides</div>
        <div class="deciding-sub">Analysing your reactions</div>
      </div>

      <img id="scene-img" src="" alt="Scene" />
      <div id="vignette"></div>
    </section>

    <!-- Sidebar -->
    <aside id="sidebar">

      <!-- Camera -->
      <div class="sidebar-section">
        <div class="section-label">Viewer Feed</div>
        <div id="webcam-wrap">
          <video id="webcam" autoplay muted playsinline></video>
          <div id="crosshair">
            <div class="ch-corner ch-tl"></div>
            <div class="ch-corner ch-tr"></div>
            <div class="ch-corner ch-bl"></div>
            <div class="ch-corner ch-br"></div>
            <div class="crosshair-center"></div>
          </div>
        </div>
        <div id="cam-status">Awaiting permission</div>
      </div>

      <!-- Emotion -->
      <div id="emotion-section">
        <div class="section-label">Emotional Reading</div>
        <div id="emotion-display">
          <span id="emotion-emoji">ğŸ˜</span>
          <div id="emotion-info">
            <div id="emotion-label">Neutral</div>
            <div id="emotion-meta">Awaiting data</div>
          </div>
        </div>
        <div id="intensity-bar-wrap">
          <div id="intensity-label">
            <span>Intensity</span>
            <span id="intensity-value">5/10</span>
          </div>
          <div id="intensity-track">
            <div id="intensity-fill"></div>
          </div>
        </div>
        <div id="attention-row">
          <div class="metric-pill">
            <span class="val" id="attention-val">â€”</span>
            <span class="key">Attention</span>
          </div>
          <div class="metric-pill">
            <span class="val" id="confidence-val">â€”</span>
            <span class="key">Confidence</span>
          </div>
        </div>
        <div class="section-label">History</div>
        <div id="emotion-history"></div>
      </div>

      <!-- Film path -->
      <div id="scene-list-section">
        <div class="section-label">Film Path</div>
        <div id="scene-list"></div>
      </div>

    </aside>
  </main>

  <!-- INFO BAR -->
  <div id="info-bar">
    <div id="narration">Press START to begin your film.</div>
    <div id="scene-meta">
      <span id="chapter-name">â€”</span>
      <span id="scene-counter">Scene 0</span>
    </div>
  </div>

  <!-- CONTROLS -->
  <div id="controls">
    <div class="controls-left">
      <button class="btn primary" id="btn-start">&#9654; Start</button>
      <button class="btn" id="btn-reset" disabled>&#8635; Reset</button>
    </div>
    <div id="status-text">
      <span id="ws-dot"></span>
      <span id="status-msg">Idle â€” press Start to begin</span>
    </div>
  </div>

</div>

<!-- END SCREEN -->
<div id="end-screen">
  <div class="end-inner">
    <div class="end-eyebrow">Your Film Has Concluded</div>
    <h2 class="end-title">Your Film DNA</h2>
    <div class="end-rule"></div>
    <div class="end-ending-name" id="end-ending-name">â€”</div>
    <div class="end-emotion-summary" id="end-emotion-summary">Dominant emotion: â€”</div>
    <div class="end-scenes">
      <div class="end-scenes-label">Scenes Witnessed</div>
      <div id="end-scene-list"></div>
    </div>
    <div class="end-rule"></div>
    <div class="end-cta">
      <button class="btn primary" id="btn-watch-again">&#8635; Watch Again</button>
      <button class="btn" id="btn-close-end">&#10005; Close</button>
    </div>
  </div>
</div>

<!-- Hidden capture canvas -->
<canvas id="capture-canvas" width="320" height="240"></canvas>
<audio id="scene-audio"></audio>

<script>
/* â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const EMOJI_MAP = {
  engaged:'ğŸ˜Š', bored:'ğŸ˜‘', confused:'ğŸ¤”',
  amused:'ğŸ˜„', tense:'ğŸ˜°', surprised:'ğŸ˜²', neutral:'ğŸ˜'
};
const EMOTION_COLORS = {
  engaged:'#2ecc71', bored:'#7f8c8d', confused:'#e67e22',
  amused:'#f1c40f', tense:'#e74c3c', surprised:'#9b59b6', neutral:'#95a5a6'
};
const ENDINGS = {
  ending_solve:       'The Truth Revealed',
  ending_bittersweet: 'A Bittersweet Resolution',
  ending_twist:       'Nothing Was As It Seemed'
};
const WS_URL = 'ws://localhost:8000/ws/session';

/* â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let appState      = 'idle'; // idle | calibrating | playing | deciding | ended
let ws            = null;
let frameTimer    = null;
let camStream     = null;
let camDenied     = false;
let sceneCount    = 0;
let scenesPlayed  = [];
let emotionHistory= [];

/* â”€â”€â”€ ELEMENT REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);
const E = {
  app:             $('app'),
  sceneImg:        $('scene-img'),
  idleOverlay:     $('idle-overlay'),
  decidingOverlay: $('deciding-overlay'),
  calibrateOverlay:$('calibrate-overlay'),
  calibrateCount:  $('calibrate-count'),
  webcam:          $('webcam'),
  camStatus:       $('cam-status'),
  emotionEmoji:    $('emotion-emoji'),
  emotionLabel:    $('emotion-label'),
  emotionMeta:     $('emotion-meta'),
  intensityFill:   $('intensity-fill'),
  intensityValue:  $('intensity-value'),
  attentionVal:    $('attention-val'),
  confidenceVal:   $('confidence-val'),
  emotionHistory:  $('emotion-history'),
  narration:       $('narration'),
  chapterName:     $('chapter-name'),
  sceneCounter:    $('scene-counter'),
  sceneList:       $('scene-list'),
  statusMsg:       $('status-msg'),
  statusText:      $('status-text'),
  wsDot:           $('ws-dot'),
  recIndicator:    $('rec-indicator'),
  btnStart:        $('btn-start'),
  btnReset:        $('btn-reset'),
  btnWatchAgain:   $('btn-watch-again'),
  btnCloseEnd:     $('btn-close-end'),
  endScreen:       $('end-screen'),
  endEndingName:   $('end-ending-name'),
  endEmotionSummary:$('end-emotion-summary'),
  endSceneList:    $('end-scene-list'),
  canvas:          $('capture-canvas'),
  audio:           $('scene-audio'),
};

/* â”€â”€â”€ CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startCamera() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { width: 320, height: 240, facingMode: 'user' },
      audio: false
    });
    E.webcam.srcObject = camStream;
    E.camStatus.textContent = 'Camera active';
    E.camStatus.className = 'ok';
    camDenied = false;
  } catch (err) {
    camDenied = true;
    E.camStatus.textContent = 'Camera denied â€” no emotion data';
    E.camStatus.className = 'error';
  }
}

function captureFrame() {
  if (!camStream || camDenied) return null;
  const ctx = E.canvas.getContext('2d');
  ctx.drawImage(E.webcam, 0, 0, 320, 240);
  return E.canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
}

/* â”€â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function connectWS() {
  if (ws && ws.readyState < 2) return;
  ws = new WebSocket(WS_URL);

  ws.addEventListener('open', () => {
    E.wsDot.className = 'connected';
    setStatus('Connected â€” press Start', false);
  });

  ws.addEventListener('close', () => {
    E.wsDot.className = 'error';
    setStatus('Connection lost â€” retryingâ€¦', true);
    stopFrameCapture();
    setTimeout(connectWS, 3000);
  });

  ws.addEventListener('error', () => {
    E.wsDot.className = 'error';
    setStatus('WebSocket error', true);
  });

  ws.addEventListener('message', evt => {
    try { handleMsg(JSON.parse(evt.data)); }
    catch(e) { console.warn('Bad WS message', e); }
  });
}

function wsSend(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
}

/* â”€â”€â”€ MESSAGE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleMsg(msg) {
  switch(msg.type) {

    case 'scene': {
      const a = msg.assets || {};
      transitionScene(a);
      sceneCount++;
      if (a.scene_id) {
        scenesPlayed.push(a.scene_id);
        renderSceneList();
      }
      E.narration.textContent  = a.narration_text || '';
      E.chapterName.textContent= a.chapter || 'â€”';
      E.sceneCounter.textContent = 'Scene ' + sceneCount;
      setDeciding(false);
      if (appState !== 'ended') setAppState('playing');
      break;
    }

    case 'emotion': {
      updateEmotion(msg.data || {});
      break;
    }

    case 'deciding': {
      setAppState('deciding');
      setDeciding(true);
      setStatus('Director is decidingâ€¦', false);
      break;
    }

    case 'complete': {
      setDeciding(false);
      stopFrameCapture();
      setAppState('ended');
      showEndScreen(msg.ending, msg.scenes_played || scenesPlayed);
      break;
    }

    case 'error': {
      setStatus('Error: ' + (msg.message || 'unknown'), true);
      break;
    }
  }
}

/* â”€â”€â”€ SCENE IMAGE CROSSFADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function transitionScene(assets) {
  const img = E.sceneImg;
  img.classList.remove('visible');
  img.classList.add('fading');

  setTimeout(() => {
    if (assets.image_base64) {
      img.src = 'data:image/png;base64,' + assets.image_base64;
      img.onload = () => {
        img.classList.remove('fading');
        img.classList.add('visible');
        E.idleOverlay.classList.add('hidden');
      };
    } else {
      img.classList.remove('fading');
      img.classList.add('visible');
      E.idleOverlay.classList.add('hidden');
    }

    if (assets.audio_base64) {
      E.audio.src = 'data:audio/wav;base64,' + assets.audio_base64;
      E.audio.play().catch(() => {});
    }
  }, 400);
}

/* â”€â”€â”€ EMOTION DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateEmotion(data) {
  const emo       = data.primary_emotion || 'neutral';
  const intensity = Math.min(10, Math.max(1, data.intensity || 5));

  E.emotionEmoji.textContent    = EMOJI_MAP[emo] || 'ğŸ˜';
  E.emotionLabel.textContent    = emo.charAt(0).toUpperCase() + emo.slice(1);
  E.emotionLabel.style.color    = EMOTION_COLORS[emo] || 'var(--white)';
  E.intensityFill.style.width   = (intensity / 10 * 100) + '%';
  E.intensityValue.textContent  = intensity + '/10';
  E.attentionVal.textContent    = data.attention || 'â€”';
  E.confidenceVal.textContent   = data.confidence != null
    ? Math.round(data.confidence * 100) + '%' : 'â€”';
  E.emotionMeta.textContent     = 'Reading #' + (emotionHistory.length + 1);

  // Bounce animation
  E.emotionEmoji.style.transform = 'scale(1.35)';
  setTimeout(() => { E.emotionEmoji.style.transform = 'scale(1)'; }, 320);

  emotionHistory.push(emo);
  if (emotionHistory.length > 8) emotionHistory = emotionHistory.slice(-8);
  renderEmotionHistory();
}

function renderEmotionHistory() {
  E.emotionHistory.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const dot = document.createElement('div');
    dot.className = 'hist-dot' + (i < emotionHistory.length ? ' active' : '');
    dot.textContent = i < emotionHistory.length ? (EMOJI_MAP[emotionHistory[i]] || '') : '';
    E.emotionHistory.appendChild(dot);
  }
}

/* â”€â”€â”€ SCENE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSceneList() {
  E.sceneList.innerHTML = '';
  scenesPlayed.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'scene-entry' + (i === scenesPlayed.length - 1 ? ' current' : '');
    div.innerHTML =
      '<span class="s-num">' + String(i+1).padStart(2,'0') + '</span>' +
      '<span>' + s.replace(/_/g,' ') + '</span>';
    E.sceneList.appendChild(div);
  });
  // scroll to bottom
  E.sceneList.parentElement.scrollTop = E.sceneList.parentElement.scrollHeight;
}

/* â”€â”€â”€ CALIBRATION COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function runCalibration(onDone) {
  setAppState('calibrating');
  E.calibrateOverlay.classList.add('active');
  let n = 3;
  E.calibrateCount.textContent = n;

  function tick() {
    n--;
    if (n > 0) {
      // Re-trigger CSS animation by forcing reflow
      E.calibrateCount.style.animation = 'none';
      E.calibrateCount.textContent = n;
      void E.calibrateCount.offsetWidth;
      E.calibrateCount.style.animation = '';
      setTimeout(tick, 1000);
    } else {
      E.calibrateOverlay.classList.remove('active');
      onDone();
    }
  }
  setTimeout(tick, 1000);
}

/* â”€â”€â”€ FRAME CAPTURE LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startFrameCapture() {
  stopFrameCapture();
  frameTimer = setInterval(() => {
    const frame = captureFrame();
    if (frame) wsSend({ type: 'frame', data: frame });
  }, 8000);
}

function stopFrameCapture() {
  if (frameTimer) { clearInterval(frameTimer); frameTimer = null; }
}

/* â”€â”€â”€ END SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showEndScreen(endingId, scenes) {
  E.endEndingName.textContent = ENDINGS[endingId] || endingId || 'The End';

  // Dominant emotion from history
  const freq = {};
  emotionHistory.forEach(e => { freq[e] = (freq[e]||0)+1; });
  const dominant = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0] || 'neutral';
  E.endEmotionSummary.textContent =
    'Dominant emotion: ' + (EMOJI_MAP[dominant]||'') + ' ' + dominant;

  // Scene list
  E.endSceneList.innerHTML = (scenes||[]).map((s,i) =>
    '<div class="end-scene-item">' +
    '<span class="idx">' + String(i+1).padStart(2,'0') + '</span>' +
    '<span>' + s.replace(/_/g,' ') + '</span>' +
    '</div>'
  ).join('');

  E.endScreen.classList.add('active');
  E.recIndicator.classList.remove('active');
  setStatus('Film complete', false);
}

function hideEndScreen() {
  E.endScreen.classList.remove('active');
}

/* â”€â”€â”€ APP STATE MACHINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setAppState(s) {
  appState = s;
  switch(s) {
    case 'idle':
      E.recIndicator.classList.remove('active');
      E.btnStart.disabled = false;
      E.btnReset.disabled = true;
      stopFrameCapture();
      break;
    case 'calibrating':
      E.btnStart.disabled = true;
      E.btnReset.disabled = true;
      break;
    case 'playing':
      E.recIndicator.classList.add('active');
      E.btnStart.disabled = true;
      E.btnReset.disabled = false;
      setStatus('Playingâ€¦', false);
      break;
    case 'deciding':
      // buttons unchanged during director decision
      break;
    case 'ended':
      E.recIndicator.classList.remove('active');
      E.btnStart.disabled = true;
      E.btnReset.disabled = false;
      stopFrameCapture();
      break;
  }
}

function setDeciding(on) {
  if (on) E.decidingOverlay.classList.add('active');
  else    E.decidingOverlay.classList.remove('active');
}

function setStatus(txt, isError) {
  E.statusMsg.textContent = txt;
  E.statusText.className = isError ? 'error' : (appState === 'playing' ? 'active' : '');
}

/* â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function doReset() {
  hideEndScreen();
  stopFrameCapture();
  sceneCount = 0;
  scenesPlayed = [];
  emotionHistory = [];
  renderEmotionHistory();
  renderSceneList();
  E.narration.textContent   = 'Restarting filmâ€¦';
  E.chapterName.textContent = 'â€”';
  E.sceneCounter.textContent= 'Scene 0';
  setDeciding(false);
  E.sceneImg.classList.remove('visible','fading');
  E.idleOverlay.classList.remove('hidden');
  setAppState('idle');
  wsSend({ type: 'reset' });
  // Server will push opening scene immediately after reset;
  // start frame capture after a brief delay to let scene arrive
  setTimeout(() => {
    startFrameCapture();
    setAppState('playing');
  }, 800);
}

/* â”€â”€â”€ BUTTON EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
E.btnStart.addEventListener('click', () => {
  if (appState !== 'idle') return;
  runCalibration(() => {
    wsSend({ type: 'start', genre: 'mystery' });
    setStatus('Starting filmâ€¦', false);
    startFrameCapture();
  });
});

E.btnReset.addEventListener('click', doReset);
E.btnWatchAgain.addEventListener('click', doReset);
E.btnCloseEnd.addEventListener('click', hideEndScreen);

/* â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async function init() {
  renderEmotionHistory();
  await startCamera();
  connectWS();
})();
</script>

</body>
</html>
